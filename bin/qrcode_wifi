#!/usr/bin/python3

import os
import time
import cv2
import requests
import rcpy
import rcpy.servo as servo
import rcpy.clock as clock

global studio_url
studio_url = "http://blupants.org"

index = 0
apiPreference = cv2.CAP_ANY

period = 0.02
servo_hor = servo.Servo(1)
servo_vert = servo.Servo(2)
clckh = clock.Clock(servo_hor, period)
clckv = clock.Clock(servo_vert, period)


def wifi_connected():
    global studio_url
    url = studio_url + "/api/v1/status"
    try:
        resp = requests.get(url=url, timeout=5)
        if resp.status_code == 200:
            return True
    except:
        return False
    return False


def _set_wifi(ssid, pw, tries=5):
    tmp_wifi_file = "/tmp/blupants/blupants_wifi"
    ap_id = ""
    ssid_found = False
    counter = 0
    cmd = "connmanctl scan wifi"
    print(cmd)
    os.system(cmd)
    time.sleep(5)
    while not ssid_found:
        cmd = "connmanctl services > {}".format(tmp_wifi_file)
        print(cmd)
        os.system(cmd)
        time.sleep(2)
        counter += 1
        with open(tmp_wifi_file) as f:
            for line in f.readlines():
                ssid_index = 0
                if not line.startswith(" "):
                    ssid_index = 1
                line = line.replace("  ", " ")
                line = line.strip()
                tmp = line.split(" ")
                if len(tmp) > 1:
                    line_ssid = tmp[ssid_index]
                    if line_ssid.lower() == ssid.lower():
                        ssid_found = True
                        ssid = tmp[ssid_index]
                        ap_id = tmp[-1]
                        break
        time.sleep(1)
        if counter >= tries:
            break
    wifi_config_file = "/var/lib/connman/{}-psk.config".format(ssid)
    print(wifi_config_file)
    with open(wifi_config_file, "w") as f:
        lines = "[service_{}]\n".format(ap_id)
        lines += "Type = wifi\n"
        lines += "Name = {}\n".format(ssid)
        lines += "Passphrase = {}".format(pw)
        f.write(lines)
        time.sleep(2)
        print(lines)

    cmd = "connmanctl connect {}".format(ap_id)
    print(cmd)
    os.system(cmd)
    time.sleep(5)


def set_config(config_data):
    # WIFI:S:BluPantslab;T:WPA;P:s3cr3t@123;;
    resp = False
    ssid = ""
    pw = ""
    if len(config_data) > 0:
        fields = config_data.split(";")
        if len(fields) > 2:
            wifi = fields[0]
            enc = fields[1]
            password = fields[2]
            wifi_fields = wifi.split(":")
            if len(wifi_fields) > 2:
                ssid = wifi_fields[2]
            password_fields = password.split(":")
            if len(password_fields) > 1:
                pw = password_fields[1]
    try:
        resp = _set_wifi(ssid, pw)
    except:
        resp = False
    return resp


def _init():
    rcpy.set_state(rcpy.RUNNING)
    # enable servos
    servo.enable()
    # start clock
    clckh.start()
    clckv.start()


def _shutdown():
    # stop clock
    clckh.stop()
    clckv.stop()
    # disable servos
    servo.disable()


def run(max_tries=-1):
    if wifi_connected():
        print("It is connected to WiFi already.")
        return

    qr_decoder = cv2.QRCodeDetector()
    cap = cv2.VideoCapture(index, apiPreference)
    print("VideoCapture(index={}, apiPreference={})".format(index, apiPreference))
    time.sleep(1)

    # Check if camera opened successfully
    if cap.isOpened():
        cap.set(cv2.CAP_PROP_FPS, 1)
        cap.set(cv2.CAP_PROP_FRAME_WIDTH, 320)
        cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 240)
        time.sleep(1)
    else:
        print("Error opening video stream or file")

    pos_begin = -0.6
    pos_end = 0.6
    step = 0.1
    pos_v = pos_h = pos_begin
    counter = 0
    # Read until video is completed
    while cap.isOpened():
        servo_vert.set(pos_v)
        servo_hor.set(pos_h)
        counter += 1
        time.sleep(0.25)
        print("Trying to connect to Wifi vi QR Code ... Attempt [{}/{}] Servo position: V:[{}] H:[{}]"
              .format(counter, max_tries, pos_v, pos_h))
        # Capture frame-by-frame
        ret, frame = cap.read()
        if ret:
            data, bbox, rectified_image = qr_decoder.detectAndDecode(frame)
            # cv2.imwrite("/tmp/blupants/{}.png".format(str(count).zfill(4)), frame)
            if len(data) > 0:
                print("Decoded Data : {}".format(data))
                set_config(data)
                time.sleep(2)
                if wifi_connected():
                    print("Successfully connected to WiFi.")
                    break
            else:
                print("QR Code not detected")
        if 0 < max_tries <= counter:
            print("Unable to connected to WiFi.")
            break
        # Servo sweep
        pos_h += step
        if pos_h > pos_end:
            pos_h = pos_begin
            pos_v += step
            if pos_v > pos_end:
                pos_v = pos_begin
    cap.release()
    print("Done!")


def main():
    _init()
    run()
    _shutdown()


if __name__ == '__main__':
    main()


